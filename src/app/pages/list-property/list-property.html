<div class="page-wrapper">
  <div class="container">

    <div class="progress-header">
      <div class="step-indicator">
        <span class="current-step-label">
          Step {{currentStep}}:
          {{ currentStep === 1 ? 'Details' :
          (currentStep === 2 ? 'Amenities' :
          (currentStep === 3 ? 'Guidebook' : 'Final Details'))
          }}
        </span>
        <span class="total-steps">{{totalSteps}} STEPS TOTAL</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" [style.width.%]="(currentStep / totalSteps) * 100"></div>
      </div>
      <div class="step-labels">
        <span [class.active]="currentStep >= 1">Details</span>
        <span [class.active]="currentStep >= 2">Amenities</span>
        <span [class.active]="currentStep >= 3">Guidebook</span>
        <span [class.active]="currentStep >= 4">Photos</span>
      </div>
    </div>

    <div class="main-card">
      <form [formGroup]="listingForm">

        <div *ngIf="currentStep === 1" formGroupName="details">
          <h1 class="section-title">Tell us about your property</h1>
          <p class="section-subtitle">Start with the basics so we can categorize your listing correctly.</p>

          <h2 class="subsection-title">What kind of place is it?</h2>
          <div class="property-type-grid">
            <label class="type-card" *ngFor="let type of propertyTypes"
              [class.selected]="detailsGroup.get('propertyType')?.value === type.value">
              <input type="radio" formControlName="propertyType" [value]="type.value" hidden>
              <mat-icon class="type-icon">{{type.icon}}</mat-icon>
              <span class="type-label">{{type.label}}</span>
              <mat-icon class="check-icon"
                *ngIf="detailsGroup.get('propertyType')?.value === type.value">check_circle</mat-icon>
            </label>
          </div>

          <h2 class="subsection-title move-down">Property Location</h2>
          <div formGroupName="address">
            <div class="property-type-grid" style="margin-top: 16px; grid-template-columns: 1fr 1fr ;">
              <div class="input-group">
                <label class="input-label">Street Address</label>
                <input type="text" formControlName="street" placeholder="e.g. 123 Main St">
              </div>
              <div class="input-group">
                <label class="input-label">Landmark</label>
                <input type="text" formControlName="landmark" placeholder="Near City Mall">
              </div>
            </div>
            <div class="property-type-grid" style="margin-top: 16px; grid-template-columns: 2fr 1fr 1fr;">
              <div class="input-group" style="margin-top:0;">
                <label class="input-label">State</label>
                <select formControlName="state">
                  <option value="">Select State</option>
                  <option *ngFor="let state of states" [value]="state.name">{{ state.name }}</option>
                </select>
              </div>
              <div class="input-group" style="margin-top:0;">
                <label class="input-label">City</label>
                <select formControlName="city">
                  <option value="">Select City</option>
                  <option *ngFor="let city of cities" [value]="city.name">{{ city.name }}</option>
                </select>
              </div>
              <div class="input-group" style="margin-top:0;">
                <label class="input-label">Zip Code</label>
                <input type="text" formControlName="zip" placeholder="400001">
              </div>
            </div>
          </div>

          <h2 class="subsection-title move-down">Accommodation</h2>
          <div class="counter-row">
            <div class="counter-label">
              <div class="label-main">Bedrooms</div>
            </div>
            <div class="counter-controls">
              <button type="button" class="counter-btn" (click)="updateCounter('bedrooms', -1)">-</button>
              <span class="counter-value">{{ detailsGroup.get('bedrooms')?.value }}</span>
              <button type="button" class="counter-btn" (click)="updateCounter('bedrooms', 1)">+</button>
            </div>
          </div>
          <div class="counter-row">
            <div class="counter-label">
              <div class="label-main">Bathrooms</div>
            </div>
            <div class="counter-controls">
              <button type="button" class="counter-btn" (click)="updateCounter('bathrooms', -1)">-</button>
              <span class="counter-value">{{ detailsGroup.get('bathrooms')?.value }}</span>
              <button type="button" class="counter-btn" (click)="updateCounter('bathrooms', 1)">+</button>
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">Size (Sq Ft)</label>
            <input type="number" formControlName="propertySize">
          </div>
        </div>


        <div *ngIf="currentStep === 2" formGroupName="amenities">
          <h1 class="section-title">Amenities & Features</h1>
          <ng-container *ngFor="let group of amenityGroups">
            <h2 class="subsection-title icon-title">{{ group.title }}</h2>
            <div class="amenities-grid">
              <label class="amenity-card" *ngFor="let item of group.items"
                [class.selected]="amenitiesGroup.get(item.formControlName)?.value === true">
                <input type="checkbox" [formControlName]="item.formControlName" hidden>
                <div class="custom-checkbox"><mat-icon
                    *ngIf="amenitiesGroup.get(item.formControlName)?.value">check</mat-icon></div>
                <span class="amenity-label">{{ item.label }}</span>
              </label>
            </div>
          </ng-container>
        </div>


        <div *ngIf="currentStep === 3" formGroupName="guidebook">
          <h1 class="section-title">Rules & Surroundings</h1>
          <p class="section-subtitle">Set clear expectations and highlight the neighborhood.</p>

          <h2 class="subsection-title">House Rules</h2>
          <div class="rules-chips-container">
            <div class="rule-chip" *ngFor="let rule of commonRules" [class.active]="isRuleSelected(rule.value)"
              (click)="toggleRule(rule.value)">
              <mat-icon>{{rule.icon}}</mat-icon>
              <span>{{rule.label}}</span>
            </div>
          </div>

          <div class="input-group" style="margin-top: 16px;">
            <label class="input-label">Additional Rules / Notes</label>
            <textarea formControlName="customRules" rows="3"
              placeholder="E.g., Please take out the trash on Tuesdays..."></textarea>
          </div>

          <div class="divider-line"></div>

          <h2 class="subsection-title">What's Nearby?</h2>
          <p class="input-helper">Help tenants know the area. Add metro stations, parks, or malls.</p>

          <div formArrayName="nearby">
            <div class="nearby-row" *ngFor="let place of nearbyPlaces.controls; let i = index" [formGroupName]="i">

              <div class="nearby-icon-box">
                <mat-icon>place</mat-icon>
              </div>

              <div class="input-col-main">
                <input type="text" formControlName="name" placeholder="Place Name (e.g. Central Park)">
              </div>

              <div class="input-col-side">
                <input type="text" formControlName="distance" placeholder="Dist (e.g. 5 min walk)">
              </div>

              <button type="button" class="btn-icon-danger" (click)="removeNearbyPlace(i)"
                *ngIf="nearbyPlaces.length > 1">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </div>

          <button type="button" class="btn-dashed" (click)="addNearbyPlace()">
            <mat-icon>add</mat-icon> Add Another Place
          </button>
        </div>


        <div *ngIf="currentStep === 4" formGroupName="final">
          <div class="two-column-layout">
            <div class="main-column">
              <h1 class="section-title">Final Details</h1>
              <p class="section-subtitle">Add photos and a description to finish your listing.</p>
              <div class="input-group">
                <label class="input-label">Contact No</label>
                <input type="text" formControlName="contactNo" placeholder="Enter contact number...">
              </div>
              <div class="input-group">
                <label class="input-label">Property Title</label>
                <input type="text" formControlName="name" placeholder="Cozy 2-bedroom apartment...">
              </div>

              <div class="input-group">
                <label class="input-label">Description</label>
                <textarea formControlName="description" rows="4"></textarea>
              </div>

              <div class="input-group">
                <label class="input-label">Monthly Rent (₹)</label>
                <input type="number" formControlName="rentAmount">
              </div>

              <h2 class="subsection-title">Photos</h2>
              <div class="photo-upload-container">
                <button type="button" class="btn-outline" (click)="fileInput.click()">
                  <mat-icon>cloud_upload</mat-icon> Upload Photos
                </button>
                <input #fileInput type="file" multiple accept="image/*" (change)="onFileSelected($event)" hidden>

                <div class="image-previews" *ngIf="imagePreviews.length > 0">
                  <div class="preview-item" *ngFor="let img of imagePreviews; let i = index">
                    <img [src]="img">
                    <button type="button" class="remove-img-btn"
                      (click)="removeImage(i)"><mat-icon>close</mat-icon></button>
                    <div class="cover-tag" *ngIf="i === 0">Cover</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="sidebar-column">
              <div class="preview-card">
                <div class="preview-image-container">
                  <img [src]="imagePreviews.length > 0 ? imagePreviews[0] : 'assets/placeholder-house.jpg'">
                  <span class="preview-badge">Preview</span>
                </div>
                <div class="preview-content">
                  <h3>{{ detailsGroup.get('bedrooms')?.value }} Bed {{ detailsGroup.get('propertyType')?.value |
                    titlecase }}</h3>
                  <div class="preview-price">₹{{ finalGroup.get('rentAmount')?.value || 0 }}/mo</div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </form>
    </div>

    <footer class="footer-actions">
      <button type="button" class="btn-ghost" (click)="prevStep()"
        [style.visibility]="currentStep === 1 ? 'hidden' : 'visible'">Back</button>
      <button type="button" class="btn-primary" (click)="nextStep()" *ngIf="currentStep < totalSteps">Next Step</button>
      <button type="button" class="btn-primary" (click)="onSubmit()" *ngIf="currentStep === totalSteps"
        [disabled]="isSubmitting" [class.disabled-btn]="isSubmitting">

        <mat-icon *ngIf="!isSubmitting">check_circle</mat-icon>
        <mat-icon *ngIf="isSubmitting" class="spinner">sync</mat-icon>

        {{ isSubmitting ? 'Saving...' : 'Finish Listing' }}
      </button>
    </footer>

  </div>
</div>