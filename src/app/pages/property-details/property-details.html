<div class="loading-state" *ngIf="isLoading">
  <mat-icon class="spinner">sync</mat-icon> Loading details...
</div>

<div class="page-container" *ngIf="!isLoading && property">

  <header class="property-header">
    <div class="header-content">
      <div class="title-section">
        <div class="breadcrumbs">
          <a routerLink="/explore">Explore</a> &gt; {{ property.city }}
        </div>
        <h1>{{ property.propertyType }} in {{ property.city }}</h1>
        <p class="address">
          <mat-icon>location_on</mat-icon>
          {{ property.street }}, {{ property.city }}, {{ property.state }}
        </p>
      </div>
      <div class="action-buttons">
        <button class="btn-outline" (click)="shareProperty()" [class.success-btn]="isCopied">

          <mat-icon>{{ isCopied ? 'check' : 'ios_share' }}</mat-icon>
          {{ isCopied ? 'Copied!' : 'Share' }}

        </button>
        <button class="btn-outline"><mat-icon>favorite_border</mat-icon> Save</button>
      </div>
    </div>
  </header>

  <section class="gallery-section">
    <div class="gallery-grid">

      <div class="main-img">
        <a [href]="(property.photos && property.photos.length > 0) ? property.photos[0].photoUrl : '#'" target="_blank">
          <img
            [src]="(property.photos && property.photos.length > 0) ? property.photos[0].photoUrl : 'assets/placeholder.jpg'"
            alt="Main">
        </a>
      </div>

      <div class="side-img">
        <a [href]="(property.photos?.length > 1) ? property.photos[1].photoUrl : (property.photos?.[0]?.photoUrl || '#')"
          target="_blank">
          <img
            [src]="(property.photos?.length > 1) ? property.photos[1].photoUrl : (property.photos?.[0]?.photoUrl || 'assets/placeholder.jpg')"
            alt="Side 1">
        </a>
      </div>

      <div class="side-img">
        <a [href]="(property.photos?.length > 2) ? property.photos[2].photoUrl : (property.photos?.[0]?.photoUrl || '#')"
          target="_blank">
          <img
            [src]="(property.photos?.length > 2) ? property.photos[2].photoUrl : (property.photos?.[0]?.photoUrl || 'assets/placeholder.jpg')"
            alt="Side 2">
        </a>
      </div>

      <div class="side-img">
        <a [href]="(property.photos?.length > 3) ? property.photos[3].photoUrl : (property.photos?.[0]?.photoUrl || '#')"
          target="_blank">
          <img
            [src]="(property.photos?.length > 3) ? property.photos[3].photoUrl : (property.photos?.[0]?.photoUrl || 'assets/placeholder.jpg')"
            alt="Side 3">
        </a>
      </div>

      <div class="side-img relative">
        <a [href]="(property.photos?.length > 0) ? property.photos[0].photoUrl : '#'" target="_blank">
          <img [src]="(property.photos?.length > 0) ? property.photos[0].photoUrl : 'assets/placeholder.jpg'" alt="More"
            style="filter: brightness(0.5);">
        </a>
        <!-- <button class="view-photos-btn">
          <mat-icon>grid_view</mat-icon> Show all photos
        </button> -->
      </div>

    </div>
  </section>

  <section class="specs-bar">
    <div class="spec-item"><mat-icon>bed</mat-icon> <strong>{{ property.bedrooms }}</strong> Beds</div>
    <div class="spec-item"><mat-icon>bathtub</mat-icon> <strong>{{ property.bathrooms }}</strong> Baths</div>
    <div class="spec-item"><mat-icon>square_foot</mat-icon> <strong>{{ property.propertySize }}</strong> Sq Ft</div>
    <div class="spec-item"><mat-icon>pets</mat-icon> <strong>{{ property.pets ? 'Allowed' : 'No Pets' }}</strong></div>
  </section>

  <div class="content-layout">
    <div class="details-column">
      <section class="info-block">
        <h2>About this home</h2>
        <p [class.truncated]="!showFullDescription">{{ property.description }}</p>
        <button class="link-btn" (click)="showFullDescription = !showFullDescription"
          *ngIf="property.description?.length > 150">
          {{ showFullDescription ? 'Show less' : 'Show more' }} <mat-icon>expand_more</mat-icon>
        </button>
      </section>

      <div class="divider"></div>

      <section class="info-block">
        <h2>What this place offers</h2>
        <div class="amenities-grid">
          <div class="amenity-item" *ngFor="let am of displayAmenities">
            <mat-icon>{{ am.icon }}</mat-icon> {{ am.label }}
          </div>
        </div>
      </section>

      <div class="divider"></div>

      <section class="info-block">
        <h2>Where you'll be</h2>
        <p style="margin-bottom: 12px;">{{ property.city }}, {{ property.state }}</p>

        <div class="map-container"
          style="height: 300px; width: 100%; border-radius: 12px; overflow: hidden; background: #eee;">

          <iframe *ngIf="mapUrl" width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0"
            marginwidth="0" [src]="mapUrl" style="border: 0;">
          </iframe>

          <div *ngIf="!mapUrl"
            style="height: 100%; display: flex; align-items: center; justify-content: center; color: #888;">
            <mat-icon class="spinner" style="margin-right: 8px;">map</mat-icon> Loading map...
          </div>

        </div>
      </section>
    </div>

    <div class="sidebar-column">
      <div class="booking-card">
        <div class="card-header">
          <div class="price">{{ formatPrice(property.rentAmount) }}<span>/mo</span></div>
        </div>
        <div class="status-tag" [ngClass]="{'available': !property.isRented, 'rented': property.isRented}">
          <mat-icon *ngIf="!property.isRented" class="tiny-icon">check_circle</mat-icon>
          <mat-icon *ngIf="property.isRented" class="tiny-icon">block</mat-icon>
          {{ property.isRented ? 'Rented' : 'Available Now' }}
        </div>
        <!-- <button class="btn-primary full-width" [disabled]="property.isRented">Request to Book</button> -->
      <button class="btn-outline full-width" (click)="scheduleTour()">
          Schedule a Tour
      </button>
      </div>
      <div class="agent-card">
        <div class="agent-info">
          <div class="avatar">AG</div>
          <div>
            <h4>Listing Agent</h4>
            <p>Property Manager</p>
          </div>
        </div>
        <button class="btn-text" (click)="contactAgent()">
          Contact Agent
      </button>
      </div>
    </div>
  </div>

  <section class="similar-section" *ngIf="similarProperties.length > 0">
    <h2>Similar homes you might like</h2>
    <div class="similar-grid">
      <a [routerLink]="['/property-details', home.id]" class="similar-card" *ngFor="let home of similarProperties">
        <img [src]="(home.photos && home.photos.length > 0) ? home.photos[0].photoUrl : 'assets/placeholder.jpg'"
          alt="Home">
        <div class="sim-details">
          <div class="sim-price">{{ formatPrice(home.rentAmount) }}<span>/mo</span></div>
          <h4>{{ home.propertyType }} in {{ home.city }}</h4>
          <p>{{ home.bedrooms }} Beds â€¢ {{ home.bathrooms }} Baths</p>
        </div>
      </a>
    </div>
  </section>

</div>

<div class="not-found-state" *ngIf="!isLoading && !property">
  <mat-icon style="font-size: 64px; height: 64px; width: 64px; color: #ccc;">search_off</mat-icon>
  <h2>Property not found</h2>
  <button mat-flat-button color="primary" routerLink="/explore">Back to Explore</button>
</div>